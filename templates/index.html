<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Keystroke Verification Test</title>
    <style>
      body {
        font-family: monospace;
        background: #0d0d0d;
        color: #dcdcdc;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        width: 80%;
        font-size: 24px;
        line-height: 36px;
        background: #111;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
      }
      .char {
        padding: 1px 2px;
        white-space: pre-wrap;
      }
      .current {
        border-bottom: 2px solid #00eaff;
      }
      .correct {
        color: #4caf50;
      }
      .incorrect {
        color: #ff4d4d;
        background: rgba(255, 0, 0, 0.06);
      }
      textarea {
        position: absolute;
        opacity: 0;
        left: -9999px;
      }
      #status {
        margin-top: 10px;
        font-size: 16px;
        color: #90caf9;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="text-display"></div>
      <div id="status">Start typing... Press ESC to predict user.</div>
    </div>

    <textarea id="hidden-input"></textarea>

    <script>
      const paragraph = `{{ text }}`;
      const display = document.getElementById("text-display");
      const input = document.getElementById("hidden-input");
      const status = document.getElementById("status");

      let index = 0;

      /* ----- Render characters ----- */
      display.innerHTML = "";
      for (const ch of paragraph) {
        const span = document.createElement("span");
        span.className = "char";
        span.textContent = ch;
        display.appendChild(span);
      }
      display.children[0].classList.add("current");

      /* ===== FIX: Use Unix timestamp in seconds ===== */
      function now() {
        return Date.now() / 1000.0; // Matches Python's time.time()
      }

      /* ----- Keystroke logging function ----- */
      function sendLog(key, event) {
        fetch("/log", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ key, event, time: now() }),
        });
      }

      /* ----- Focus input ----- */
      function focusInput() {
        if (document.activeElement !== input) input.focus();
      }
      document.addEventListener("click", focusInput);
      document.addEventListener("keydown", focusInput);
      input.focus();

      /* ----- Predict request ----- */
      async function triggerPredict() {
        status.innerText = "Predicting user...";
        const res = await fetch("/predict", { method: "POST" });
        const data = await res.json();
        status.innerText = "Detected User: " + data.user;
      }

      /* ----- Typing logic ----- */
      document.addEventListener("keydown", function (e) {
        focusInput();

        // ESC → predict
        if (e.key === "Escape") return triggerPredict();

        sendLog(e.key, "down");

        // Backspace
        if (e.key === "Backspace") {
          e.preventDefault();
          if (index > 0) {
            display.children[index].classList.remove("current");
            index--;
            display.children[index].classList.remove("correct", "incorrect");
            display.children[index].classList.add("current");
          }
          return;
        }

        const char = e.key.length === 1 ? e.key : null;
        if (!char) return;

        e.preventDefault();

        const expected = display.children[index]?.textContent;
        if (char === expected) {
          display.children[index].classList.add("correct");
        } else {
          display.children[index].classList.add("incorrect");
        }

        display.children[index].classList.remove("current");
        index++;
        if (display.children[index])
          display.children[index].classList.add("current");

        // finished typing → predict
        if (index >= paragraph.length) triggerPredict();
      });

      /* ----- Key release ----- */
      document.addEventListener("keyup", (e) => {
        sendLog(e.key, "up");
      });
    </script>
  </body>
</html>
